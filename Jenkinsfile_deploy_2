pipeline {
    agent any 
    tools {
        terraform 'Terraform-1.4.2'
    }
    stages {
        
        stage('Run CI?') {
          steps {
            script {
              sh 'git log -1'
              if (sh(script: "git log -1 | grep '.*\\[ci skip\\].*'", returnStatus: true) == 0) {
                currentBuild.result = 'NOT_BUILT'
                error "'[ci skip]' found in git commit message. Aborting..."
              }
            }
          }
        } 
        
        stage('---Version---') { 
            steps {
                sh 'mvn -version'
            }
        }   
                     
        stage('---Clean---') { 
            steps {
                sh 'mvn clean'
            }
        }
        
        stage('---Test---') { 
            steps {
                sh 'mvn test'
            }
        }
        
        stage('---Package---') { 
            steps {
                sh 'mvn assembly:single'
            }
        }
        
        stage('---Infrastructure Provisioning---') {
            steps {
                sh '''terraform init
                terraform plan -out=main.tfplan
                terraform apply -auto-approve main.tfplan'''
            }
        }
        
        stage('---Deployment---') {
            steps {
                sh 'chmod 400 linuxkey.pem'
                script {
                    def IP = sh(script: "terraform output public_ip", returnStdout: true).trim()
                    def publicIP = IP.replaceAll('"','')
                    env.PUBLIC_IP = publicIP
                }
                sh '''ssh -i linuxkey.pem -o StrictHostKeyChecking=accept-new -T linuxusr@$PUBLIC_IP <<EOF
                echo "Testing..."
                whoami
                sudo apt update
                sudo apt install -y openjdk-11-jdk
                java --version
                exit
                EOF'''
                sh 'scp -i linuxkey.pem -o StrictHostKeyChecking=accept-new target/Calculator-1.0-SNAPSHOT-jar-with-dependencies.jar linuxusr@$PUBLIC_IP:/home/linuxusr'
            }
        }     
             
    }
}
